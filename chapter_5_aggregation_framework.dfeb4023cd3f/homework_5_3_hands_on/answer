db.grades.aggregate([
  {
    "$match": {
      "scores.type": {
        "$in": ["exam", "homework"]
      }
    }
  },
  {
    "$unwind": "$scores"
  },
  {
    "$group": {
      _id: {"student_id": "$student_id", "class_id": "$class_id"},
      sGPA: {"$avg": "$scores.score"}
    }
  },
  {
    "$group": {
      _id: {"class_id": "$_id.class_id"},
      cGPA: {"$avg": "$sGPA"}
    }
  },
  {
    "$sort": {
      cGPA: -1
    }
  }
])